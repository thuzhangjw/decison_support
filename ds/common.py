import pandas as pd
import pinyin
import json
from collections import OrderedDict 


CLASSES = ['不稳定型心绞痛', '冠状动脉粥样硬化', '房颤', '急性心肌梗死', '非ST段抬高型心肌梗死']

MODEL_DIR = '/models'
DS_MODEL_NAME = 'decision_support'

DATA_PARTITION_TABLE = OrderedDict([
        ('性别', ['男', '女']),
        ('年龄', ([(0, 18), (18, 28), (28, 40), (40, 65), (65, 75), (75, 110)], None)),
        ('血型', ['A', 'B', 'AB', 'O']),
        ('舒张压', ([(0, 60), (60, 90), (90, 120), (120, 200)], 'mmHg')),
        ('收缩压', ([(0, 90), (90, 140), (140, 200), (200, 300)], 'mmHg')),
        ('心脏心律', ['绝对不齐', '不齐', '齐']),
        ('心音s1', ['分裂', '减弱', '强弱不等', '增强', '正常']),
        ('心音s2', ['分裂', '减弱', '强弱不等', '增强', '正常']),
        ('心音s3', ['无', '有']),
        ('心音s4', ['无', '有']),
        ('心音a2', ['减弱', '亢进', '正常']),
        ('心音p2', ['减弱', '亢进', '正常']),
        ('心音a2和p2关系', ['>', '=', '<']),
        ('心率', ([(0, 50), (50, 60), (60, 100), (100, 200)], '次/分')),
        ('(WBC)白细胞', ([(0, 3.2), (3.2, 4), (4, 10.01), (10.01, 12), (12, 20), (20, 100)], 'G/L')),
        ('(PLT)血小板', ([(0, 80), (80, 100), (100, 301), (301, 360), (360, 600), (600, 900)], 'G/L')),
        ('(RBC)红细胞计数', ([(0, 3.2), (3.2, 4), (4, 5.51), (5.51, 6.6), (6.6, 10)], 'T/L')),
        ('(MCHC)平均红细胞Hb浓度', ([(0, 240), (240, 300), (300, 360), (360, 430), (430, 720)], 'g/L')),
        ('(HB)血红蛋白', ([(0, 8.8), (8.8, 11), (11, 16.1), (16.1, 19.2), (19.2, 32)], 'g/dL')),
        ('(LYMBFB)淋巴细胞百分比', ([(0, 16), (16, 20), (20, 40.1), (40.1, 48), (48, 80), (80, 100)], '%')),
        ('(MONBFB)单核细胞百分比', ([(0, 2.4), (2.4, 3), (3, 8.1), (8.1, 9.6), (9.6, 16), (16, 24)], '%')),
        ('(NE)中性粒细胞数', ([(0, 1.44), (1.44, 1.8), (1.8, 6.3), (6.3, 7.56), (7.56, 12.6)], 'G/L')),
        ('(MON)单核细胞数', ([(0, 0.24), (0.24, 0.3), (0.3, 0.81), (0.81, 0.96), (0.96, 1.6), (1.6, 3.2)], 'G/L')),
        ('(HCT)红细胞压积', ([(0, 28), (28, 35), (35, 50), (50, 60), (60, 80)], '%')),
        ('(MCV)红细胞平均体积', ([(0, 64), (64, 80), (80, 100.1), (100.1, 125)], 'fL')),
        ('(RDWSD)红细胞分布宽度-SD值', ([(28, 35), (35, 56.1), (56.1, 67.3), (67.3, 90)], 'fL')),
        ('(RDWCV)红细胞分布宽度-CV值', ([(11, 16), (16, 19.3), (19.3, 32)], '%')),
        ('(MPV)平均血小板体积', ([(0, 5.6), (5.6, 7), (7, 13.1), (13.1, 15.7)], 'fL')),
        ('(EOSBFB)嗜酸细胞百分比', ([(0, 0.32), (0.32, 0.4), (0.4, 8.01), (8.01, 9.61), (9.61, 16), (16, 34)], '%')),
        ('(BAS)嗜碱细胞数', ([(0, 0.2), (0.2, 0.4), (0.4, 1), (1, 2)], 'G/L')),
        ('(PLCR)大血小板比率', ([(0, 10), (10, 13), (13, 45), (45, 54), (54, 80)], '%')),
        ('(BUN)尿素', ([(0, 2.24), (2.24, 2.8), (2.8, 7.21), (7.21, 8.64), (8.64, 14.4), (14.4, 28.8), (28.8, 50)], 'mmol/L')),
        ('(CREA)肌酐', ([(0, 0.0352), (0.0352, 0.044), (0.044, 0.1061), (0.1061, 0.1272), (0.1272, 0.212), (0.212, 0.5)], 'mmol/L')),
        ('(HDL)高密度脂蛋白', ([(0, 0.56), (0.56, 0.7), (0.7, 2.01), (2.01, 2.4), (2.4, 4)], 'mmol/L')),
        ('(LDL)低密度脂蛋白', ([(0, 3.121), (3.121, 3.744), (3.744, 6.241), (6.241, 12.481)], 'mmol/L')),
        ('(TC)总胆固醇', ([(0, 2.281), (2.281, 2.85),(2.85, 5.7),(5.7, 6.84), (6.84, 11.4), (11.4, 22.8)], 'mmol/L')),
        ('(TG)甘油三酯', ([(0, 0.36), (0.36, 0.45), (0.45, 1.7), (1.7, 2.251), (2.251, 6.8), (6.8, 15), (15, 50)], 'mmol/L')),
        ('(UA)尿酸', ([(0, 71.2), (71.2, 89), (89, 416.1), (416.1, 499.2), (499.2, 832), (832, 1200)], 'umol/L')),
        ('钾(K)', ([(0, 2.8), (2.8, 3.5), (3.5, 5.31), (5.31, 6.36), (6.36, 10.6), (10.62, 20)], 'mmol/L')),
        ('钠(NA)', ([(0, 108), (108, 135), (135, 146), (146, 175)], 'mmol/L')),
        ('氯(CL)', ([(0, 76.8), (76.8, 96), (96, 106), (106, 140)], 'mmol/L')),
        ('钙(CA)', ([(0, 1.8), (1.8, 2), (2, 2.55), (2.55, 3.06), (3.06, 5)], 'mmol/L')),
        ('镁(MG)', ([(0, 0.64), (0.64, 0.8), (0.8, 1.01), (1.01, 1.21), (1.21, 3)], 'mmol/L')),
        ('无机磷测定(P)', ([(0, 0.56), (0.56, 0.7), (0.7, 1.451), (1.451, 1.74), (1.74, 2.91), (2.91, 6.1)], 'mmol/L')),
        ('(LDH)乳酸脱氢酶', ([(0, 87.2), (87.2, 109), (109, 246), (246, 295), (295, 490), (490, 2000)], 'U/L')),
        ('便潜血(BOBB)', ['弱阳性', '阳性', '阴性']),
        ('(AST)谷草转氨酶', ([(0, 40.1), (40.1, 48), (48, 80), (80, 160), (160, 240)], 'U/L')),
        ('(ALP)碱性磷酸酶', ([(0, 36), (36, 45), (45, 136), (136, 162), (162, 270), (270, 540)], 'U/L')),
        ('(TBA)血清总胆汁酸', ([(0, 12.1), (12.1, 14.4), (14.4, 24), (24, 48), (48, 72)], 'umol/L')),
        ('(TP)总蛋白', ([(0, 48), (48, 60), (60, 85.1), (85.1, 102.1), (102.1, 170.1)], 'g/L')),
        ('(ALB)白蛋白', ([(0, 28), (28, 35), (35, 55.1), (55.1, 66.1), (66.1, 110)], 'g/L')),
        ('(GA)糖化血清白蛋白', ([(0, 8.8), (8.8, 11), (11, 16.1), (16.1, 19.3), (19.3, 32.1), (32.1, 64)], '%')),
        ('(DDIMER)D-二聚体定量', ([(0, 201), (201, 240), (240, 401), (401, 801)], 'ug/L')),
        ('(GLU)葡萄糖', ([(0, 3.12), (3.12, 3.9), (3.9, 6.11), (6.11, 7.32), (7.32, 12.2), (12.2, 24.4), (24.4, 36.6)], 'mmol/L')),
        ('(PCO2)二氧化碳分压', ([(0, 28), (28, 35), (35, 45), (45, 54), (54, 110)], 'mmHg')),
        ('(SO2)氧饱和度', ([(0, 73.5), (73.5, 91.9), (91.9, 99.1), (99.1, 110)], '%')),
        ('(BASBFB)嗜碱细胞百分比', ([(0, 1.01), (1.01, 1.2), (1.2, 2), (2, 4)], '%')),
        ('(FBG)纤维蛋白原定量', ([(0, 1.6), (1.6, 2), (2, 4.01), (4.01, 4.81), (4.81, 8), (8, 16)], 'g/L')),
        ('(HCY)同型半胱氨酸', ([(0, 4), (4, 10), (10, 15.4), (15.4, 20), (20, 30), (30, 60), (60, 120)], 'umol/L')),
        ('(NEBFB)中性粒细胞百分比', ([(0, 40), (40, 50), (50, 70.1), (70.1, 84.1), (84.1, 100)], '%'))
        ])

LABEL_NAME = 'GB/T-codename'
CMH_NAME = '现病史'

def generate_schema():
    schema = {'label': CLASSES}
    features = [{'col_name': CMH_NAME, 'col_type': 'string'}]
    for key in DATA_PARTITION_TABLE:
        val = DATA_PARTITION_TABLE[key]
        if isinstance(val, tuple):
            feature = {
                    'col_name': key,
                    'col_type': 'float',
                    'unit': val[1]  
                    }
        else:
            feature = {
                    'col_name': key,
                    'col_type': 'enum',
                    'options': val
                    }
        features.append(feature)
    schema['features'] = features
    return schema 

